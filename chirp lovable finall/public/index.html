<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chirp 3 HD Unlimited Reader</title>
    <meta name="description" content="Premium HD text-to-speech audio generation powered by Google Cloud TTS and Chirp 3 HD voices">
    <meta name="robots" content="noindex, nofollow">
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* iOS System Font Stack */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Custom Scrollbar */
        textarea::-webkit-scrollbar, div::-webkit-scrollbar { width: 6px; }
        textarea::-webkit-scrollbar-track, div::-webkit-scrollbar-track { background: transparent; }
        textarea::-webkit-scrollbar-thumb, div::-webkit-scrollbar-thumb { background: #48484a; border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb:hover, div::-webkit-scrollbar-thumb:hover { background: #636366; }

        /* Playlist & Dropdown Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #636366; border-radius: 4px; }
        
        /* Visualizer Animation */
        .waveform-bar { animation: wave 1s ease-in-out infinite; }
        @keyframes wave {
            0%, 100% { height: 20%; opacity: 0.5; }
            50% { height: 100%; opacity: 1; }
        }

        /* iOS Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            height: 20px;
            margin: 0;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #3a3a3c;
            border-radius: 2px;
            transition: background 0.2s;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #0A84FF; /* System Blue */
            cursor: pointer;
            margin-top: -7px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transform: scale(0);
            transition: transform 0.1s;
        }
        input[type=range]:not(:disabled)::-webkit-slider-thumb {
            transform: scale(1);
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(28, 28, 30, 0.75);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }
        
        .glass-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Particle Canvas */
        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* Behind everything */
            pointer-events: none;
        }

        /* Utilities */
        .icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .icon-btn:active { transform: scale(0.95); }

        /* Auth Animations */
        .fade-enter { opacity: 0; transform: scale(0.95); }
        .fade-enter-active { opacity: 1; transform: scale(1); transition: opacity 300ms, transform 300ms; }
        .fade-exit { opacity: 1; transform: scale(1); }
        .fade-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 300ms, transform 300ms; }
        
        .auth-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.2s;
        }
        .auth-input:focus {
            outline: none;
            border-color: #0A84FF;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Smooth transitions */
        * {
            scroll-behavior: smooth;
        }
        
        /* GPU acceleration for animations */
        .glass-panel, .icon-btn, #playerBar, #particleCanvas {
            will-change: transform, opacity;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        
        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Prevent text selection on buttons */
        button, .icon-btn {
            user-select: none;
            -webkit-user-select: none;
        }

        /* Smooth focus states */
        button:focus-visible, input:focus-visible, a:focus-visible {
            outline: 2px solid #0A84FF;
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-black text-white h-screen flex flex-col selection:bg-[#0A84FF] selection:text-white overflow-hidden relative">

    <!-- Particle Background (Shared) -->
    <canvas id="particleCanvas"></canvas>
    
    <!-- LOADING SCREEN -->
    <div id="loadingScreen" class="fixed inset-0 z-[100] bg-black flex items-center justify-center transition-opacity duration-500">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-[#3A3A3C] border-t-[#0A84FF] rounded-full animate-spin"></div>
            <span class="text-[#8E8E93] text-sm font-medium tracking-wide">INITIALIZING</span>
        </div>
    </div>

    <!-- AUTHENTICATION UI -->
    <div id="authContainer" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="glass-panel w-full max-w-[400px] p-8 rounded-3xl shadow-2xl relative overflow-hidden flex flex-col gap-6">
            
            <!-- Header -->
            <div class="text-center space-y-2">
                <div class="w-12 h-12 bg-gradient-to-br from-[#0A84FF] to-[#007AFF] rounded-xl flex items-center justify-center mx-auto shadow-lg shadow-blue-900/40 mb-4">
                     <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h2.5L7 3l5 18 5-13 2.5 4H22"/></svg>
                </div>
                <h2 class="text-2xl font-bold tracking-tight">Welcome to Chirp</h2>
                <p class="text-[#8E8E93] text-sm">Sign in to access unlimited HD audio generation.</p>
            </div>

            <!-- Auth Form -->
            <form id="authForm" class="space-y-4">
                <div class="space-y-4">
                    <input type="email" id="emailInput" placeholder="Email address" class="auth-input" required>
                    <input type="password" id="passwordInput" placeholder="Password" class="auth-input" required>
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <div class="relative">
                            <input type="checkbox" id="rememberMe" class="peer sr-only" checked>
                            <div class="w-5 h-5 border-2 border-[#636366] rounded-md peer-checked:bg-[#0A84FF] peer-checked:border-[#0A84FF] transition-all"></div>
                            <svg class="absolute top-0.5 left-0.5 w-4 h-4 text-white opacity-0 peer-checked:opacity-100 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                        <span class="text-sm text-[#8E8E93] group-hover:text-white transition-colors">Remember me</span>
                    </label>
                    <a href="#" class="text-sm text-[#0A84FF] hover:underline" id="forgotPasswordBtn">Forgot?</a>
                </div>

                <button type="submit" id="authSubmitBtn" class="w-full bg-[#0A84FF] hover:bg-[#0062CC] text-white font-semibold py-3 rounded-xl transition-all active:scale-[0.98] shadow-lg shadow-blue-900/20">
                    Sign In
                </button>
            </form>

            <!-- Divider -->
            <div class="relative flex items-center py-2">
                <div class="flex-grow border-t border-[#38383A]"></div>
                <span class="flex-shrink-0 mx-4 text-[#636366] text-xs uppercase tracking-wider">Or continue with</span>
                <div class="flex-grow border-t border-[#38383A]"></div>
            </div>

            <!-- Google Sign In -->
            <button id="googleSignInBtn" type="button" class="w-full bg-white text-black font-medium py-3 rounded-xl transition-all hover:bg-gray-100 active:scale-[0.98] flex items-center justify-center gap-3">
                <svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.26-.19-.58z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                <span>Google</span>
            </button>

            <!-- Toggle Mode -->
            <div class="text-center mt-2">
                <span class="text-[#8E8E93] text-sm" id="authToggleText">Don't have an account?</span>
                <button id="authToggleBtn" type="button" class="text-[#0A84FF] text-sm font-medium hover:underline ml-1">Sign up</button>
            </div>
            
            <div id="authErrorMsg" class="text-[#FF453A] text-sm text-center hidden mt-2 break-words"></div>
        </div>
    </div>

    <!-- PAYWALL UI (Shown after Login if no subscription) -->
    <div id="paywallContainer" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="glass-panel w-full max-w-[400px] p-8 rounded-3xl shadow-2xl relative overflow-hidden flex flex-col gap-6 text-center">
            <div class="w-16 h-16 bg-[#0A84FF]/20 text-[#0A84FF] rounded-2xl flex items-center justify-center mx-auto shadow-lg">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            </div>
            
            <div class="space-y-2">
                <h2 class="text-2xl font-bold tracking-tight">Unlock Unlimited</h2>
                <p class="text-[#8E8E93] text-sm leading-relaxed">
                    Get access to premium HD voices, unlimited generation, and download capabilities.
                </p>
            </div>

            <div class="py-2">
                <div class="flex items-end justify-center gap-1">
                    <span class="text-4xl font-bold text-white">â‚¬2.99</span>
                    <span class="text-[#8E8E93] text-lg mb-1">/mo</span>
                </div>
            </div>

            <button id="subscribeBtn" class="w-full bg-[#0A84FF] hover:bg-[#0062CC] text-white font-semibold py-3 rounded-xl transition-all active:scale-[0.98] shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2">
                <span>Subscribe Now</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="9 18 15 12 9 6"/></svg>
            </button>
            
            <p id="checkoutStatus" class="text-xs text-[#8E8E93] hidden"></p>
            
            <button id="signOutFromPaywallBtn" class="text-sm text-[#8E8E93] hover:text-white transition-colors mt-2">
                Sign Out
            </button>
        </div>
    </div>
    
    <!-- MAIN APP UI (Initially Hidden) -->
    <div id="appContainer" class="flex-1 flex flex-col h-full w-full hidden opacity-0 transition-opacity duration-500">
        <!-- Header -->
        <header class="absolute top-0 w-full z-50 glass-panel border-b-0 px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-[#0A84FF] to-[#007AFF] text-white w-8 h-8 flex items-center justify-center rounded-lg shadow-lg shadow-blue-900/40">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h2.5L7 3l5 18 5-13 2.5 4H22"/></svg>
                </div>
                <div>
                    <h1 class="font-semibold text-lg leading-tight tracking-tight">Chirp Reader</h1>
                </div>
            </div>
            <div class="flex items-center gap-3">
                 <button id="manageSubBtn" class="text-xs font-medium text-[#8E8E93] hover:text-white hover:bg-[#1C1C1E] px-3 py-1.5 rounded-full border border-transparent hover:border-white/10 transition-all mr-1">
                    Manage Subscription
                </button>
                <div class="text-[11px] font-medium text-[#8E8E93] bg-[#1C1C1E] px-2 py-1 rounded-md border border-white/5 hidden sm:block">
                    Premium Active
                </div>
                <button id="signOutBtn" class="text-xs text-[#FF453A] font-medium hover:bg-[#1C1C1E] px-3 py-1.5 rounded-full border border-transparent hover:border-white/10 transition-all">Sign Out</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col max-w-4xl mx-auto w-full pt-20 pb-0 px-4 gap-4 h-full overflow-hidden z-10">
            
            <!-- Grouped Settings -->
            <div class="bg-[#1C1C1E] rounded-2xl border border-white/5 shrink-0 z-40 relative">
                <!-- API Key -->
                <div class="p-3 flex flex-col sm:flex-row items-center gap-3 border-b border-[#38383A]">
                    <div class="w-8 h-8 rounded-full bg-[#2C2C2E] flex items-center justify-center shrink-0 text-[#8E8E93]">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                    </div>
                    <input type="password" id="apiKey" placeholder="Google Cloud API Key (for TTS)" 
                        class="flex-1 bg-transparent text-[15px] text-white placeholder-[#636366] focus:outline-none w-full"
                    >
                </div>
                
                <!-- Voice Selection (Custom Dropdown) -->
                <div class="p-3 flex flex-col sm:flex-row items-center gap-3 relative z-50">
                    <div class="w-8 h-8 rounded-full bg-[#2C2C2E] flex items-center justify-center shrink-0 text-[#0A84FF]">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                    </div>
                    
                    <!-- Custom Dropdown Container -->
                    <div class="relative flex-1 w-full" id="customVoiceDropdown">
                        <!-- Trigger -->
                        <div id="voiceDropdownTrigger" class="w-full bg-transparent text-[15px] text-white flex items-center justify-between cursor-pointer py-1">
                            <span id="selectedVoiceLabel" class="truncate">Select a Voice...</span>
                            <svg class="text-[#636366]" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                        </div>

                        <!-- Options List (Hidden by default) -->
                        <div id="voiceDropdownOptions" class="absolute top-full left-0 w-full mt-2 bg-[#2C2C2E] border border-white/10 rounded-xl shadow-2xl max-h-64 overflow-y-auto custom-scroll hidden">
                            <!-- Items injected via JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Text Input Area -->
            <div class="flex-1 bg-[#1C1C1E] rounded-2xl border border-white/5 relative flex flex-col min-h-0 overflow-hidden group mb-80 transition-all duration-300" id="textAreaContainer">
                
                <!-- Watermark -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none select-none z-0 overflow-hidden">
                    <span class="text-white font-bold text-4xl sm:text-5xl opacity-[0.03] text-center tracking-widest whitespace-nowrap" style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;">
                        AI DIRECTOR'S CLUB
                    </span>
                </div>

                <!-- Text Input (Editable) -->
                <textarea id="textInput" 
                    class="flex-1 w-full h-full p-5 bg-transparent resize-none focus:outline-none text-[17px] leading-relaxed text-white placeholder-[#636366] relative z-10"
                    placeholder="Paste text here to listen..."
                ></textarea>
                
                <!-- Controls Overlay (Initial) -->
                <div class="absolute bottom-5 right-5 flex gap-3 transition-opacity duration-300 z-20" id="startControls">
                    <button id="clearBtn" class="bg-[#2C2C2E] hover:bg-[#3A3A3C] text-[#8E8E93] hover:text-white px-4 py-2 rounded-full text-[13px] font-medium transition-all backdrop-blur-sm">
                        Clear
                    </button>
                    <button id="playBtn" class="bg-[#0A84FF] hover:bg-[#0062CC] text-white px-6 py-2 rounded-full text-[15px] font-semibold transition-transform active:scale-95 shadow-lg flex items-center gap-2">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <span>Synthesize & Play</span>
                    </button>
                </div>
            </div>
        </main>

        <!-- Floating Re-open Button -->
        <button id="restorePlayerBtn" class="fixed bottom-20 left-1/2 -translate-x-1/2 w-14 h-14 bg-[#0A84FF] rounded-full shadow-2xl icon-btn text-white z-40 hidden hover:scale-105 transition-transform">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
        </button>

        <!-- Fixed Bottom Player -->
        <div id="playerBar" class="fixed bottom-20 w-full max-w-4xl left-0 right-0 mx-auto glass-panel pb-6 pt-4 px-6 flex flex-col gap-3 transform translate-y-[200%] opacity-0 blur-xl scale-95 pointer-events-none transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) z-50 rounded-3xl border border-white/10 shadow-2xl">
            
            <!-- Top Row: Info & Visualizer & Toggles -->
            <div class="relative flex justify-between items-center w-full">
                
                <!-- Left: Playlist Toggle (Integrated) -->
                <div class="z-10">
                    <button id="playlistToggleBtn" class="p-2 text-[#8E8E93] hover:text-[#0A84FF] -ml-2 transition-colors" title="Playlist">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                    </button>
                </div>

                <!-- Center: Text Info (Absolutely Centered) -->
                <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col overflow-hidden text-center max-w-[60%]">
                    <span class="text-[10px] text-[#8E8E93] font-medium uppercase tracking-wide">Now Playing</span>
                    <div class="flex items-center justify-center gap-2">
                        <span class="text-white font-semibold text-base truncate">Chunk <span id="currentChunkDisplay">1</span> / <span id="totalChunkDisplay">--</span></span>
                        <span id="statusText" class="text-[11px] text-[#0A84FF] font-medium animate-pulse">Buffering...</span>
                    </div>
                </div>

                <!-- Right: Visualizer & Minimize (Integrated) -->
                <div class="z-10 flex items-center gap-3">
                    <div class="h-4 flex items-end gap-[2px] opacity-0 transition-opacity duration-300" id="visualizer">
                        <div class="w-1 bg-[#0A84FF] h-2 rounded-full waveform-bar" style="animation-delay: 0s"></div>
                        <div class="w-1 bg-[#0A84FF] h-full rounded-full waveform-bar" style="animation-delay: 0.1s"></div>
                        <div class="w-1 bg-[#0A84FF] h-3 rounded-full waveform-bar" style="animation-delay: 0.2s"></div>
                        <div class="w-1 bg-[#0A84FF] h-1 rounded-full waveform-bar" style="animation-delay: 0.3s"></div>
                        <div class="w-1 bg-[#0A84FF] h-2 rounded-full waveform-bar" style="animation-delay: 0.15s"></div>
                    </div>
                    <!-- Min Button (Moved here, ensuring it stays within width) -->
                    <button id="hidePlayerBtn" class="p-2 text-[#8E8E93] hover:text-white -mr-2 transition-colors" title="Minimize">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                </div>
            </div>

            <!-- Middle Row: Scrubber -->
            <div class="w-full flex items-center gap-3">
                <span class="text-[10px] text-[#8E8E93] tabular-nums w-8 text-right" id="currentTimeText">0:00</span>
                <div class="relative flex-1 h-5 flex items-center group">
                    <input type="range" id="seekSlider" min="0" max="100" value="0" step="0.001" class="relative z-10 w-full" disabled>
                </div>
                <span class="text-[10px] text-[#8E8E93] tabular-nums w-8" id="durationText">0:00</span>
            </div>

            <!-- Bottom Row: Controls -->
            <div class="relative flex justify-between items-center w-full pb-0">
                <!-- Left: Options -->
                <div class="z-10 flex items-center gap-2">
                    <div class="flex items-center gap-1">
                        <a id="downloadChunkBtn" href="#" download="segment.wav" class="w-9 h-9 rounded-full flex items-center justify-center text-[#8E8E93] hover:text-white hover:bg-[#2C2C2E] transition-all" title="Download Current Chunk">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </a>
                        <span class="text-[9px] text-[#8E8E93]">Chunk</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <button id="downloadFullBtn" class="w-9 h-9 rounded-full flex items-center justify-center text-[#8E8E93] hover:text-[#0A84FF] hover:bg-[#2C2C2E] transition-all" title="Download Combined File">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                        </button>
                        <span class="text-[9px] text-[#8E8E93]">Full</span>
                    </div>
                </div>

                <!-- Center: Transport (Absolutely Centered) -->
                <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center gap-6">
                    <!-- Prev -->
                    <button id="prevBtn" class="text-white hover:text-[#0A84FF] transition-colors active:scale-90 p-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 20L9 12l10-8v16zM5 19V5h2v14H5z"/></svg>
                    </button>
                    
                    <!-- Play/Pause -->
                    <button id="mainPlayPauseBtn" class="w-14 h-14 rounded-full bg-white text-black flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-lg">
                        <svg id="playIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </button>

                    <!-- Next -->
                    <button id="nextBtn" class="text-white hover:text-[#0A84FF] transition-colors active:scale-90 p-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M5 4l10 8-10 8V4zm14 1v14h-2V5h2z"/></svg>
                    </button>
                </div>

                <!-- Right: Stop -->
                <div class="z-10">
                    <button id="mainStopBtn" class="w-10 h-10 rounded-full flex items-center justify-center text-[#FF453A] hover:bg-[#FF453A] hover:text-white transition-all bg-[#2C2C2E]">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Playlist Overlay -->
        <div id="playlistOverlay" class="fixed inset-0 z-[60] glass-overlay hidden flex-col justify-end sm:justify-center p-4">
            <div class="bg-[#1C1C1E] w-full max-w-lg mx-auto rounded-3xl overflow-hidden border border-white/10 shadow-2xl flex flex-col max-h-[80vh]">
                <!-- Playlist Header -->
                <div class="p-4 border-b border-[#38383A] flex items-center justify-between bg-[#2C2C2E]">
                    <h3 class="font-semibold text-lg">Playlist</h3>
                    <div class="flex gap-2">
                        <button id="playlistDownloadAllBtn" class="text-xs bg-[#0A84FF] text-white px-3 py-1.5 rounded-full font-medium hover:bg-blue-600 transition-colors">
                            Download All
                        </button>
                        <button id="closePlaylistBtn" class="w-8 h-8 rounded-full bg-[#3A3A3C] icon-btn text-[#8E8E93] hover:text-white">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                </div>
                <!-- List -->
                <div id="playlistContainer" class="overflow-y-auto p-2 custom-scroll flex-1">
                    <div class="text-center text-[#8E8E93] py-8 text-sm">No chunks generated yet.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Audio Element -->
    <audio id="audioPlayer" class="hidden"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-functions.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCkqfwZTiIpQ652aUqgfLvHN6ft2kDo5nU",
            authDomain: "chirp-3-unlimited.firebaseapp.com",
            projectId: "chirp-3-unlimited",
            storageBucket: "chirp-3-unlimited.firebasestorage.app",
            messagingSenderId: "996765066152",
            appId: "1:996765066152:web:9519d0d56bdd86c45ef39d",
            measurementId: "G-15084MZHND"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app, 'europe-west3');
        
        // --- Auth & Subscription UI Logic ---
        const authContainer = document.getElementById('authContainer');
        const paywallContainer = document.getElementById('paywallContainer');
        const appContainer = document.getElementById('appContainer');
        const loadingScreen = document.getElementById('loadingScreen');
        
        const authForm = document.getElementById('authForm');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const authToggleBtn = document.getElementById('authToggleBtn');
        const authToggleText = document.getElementById('authToggleText');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const rememberMeCheckbox = document.getElementById('rememberMe');
        const authErrorMsg = document.getElementById('authErrorMsg');
        const signOutBtn = document.getElementById('signOutBtn');
        const signOutFromPaywallBtn = document.getElementById('signOutFromPaywallBtn');
        
        const subscribeBtn = document.getElementById('subscribeBtn');
        const checkoutStatus = document.getElementById('checkoutStatus');
        const manageSubBtn = document.getElementById('manageSubBtn');

        let isSignUp = false;
        let currentUser = null;
        let subListener = null;

        // Toggle Sign In / Sign Up Mode
        authToggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isSignUp = !isSignUp;
            if (isSignUp) {
                authSubmitBtn.innerText = "Sign Up";
                authToggleText.innerText = "Already have an account?";
                authToggleBtn.innerText = "Sign in";
            } else {
                authSubmitBtn.innerText = "Sign In";
                authToggleText.innerText = "Don't have an account?";
                authToggleBtn.innerText = "Sign up";
            }
            authErrorMsg.classList.add('hidden');
        });

        // Input validation helpers
        function sanitizeEmail(email) {
            if (!email || typeof email !== 'string') return '';
            return email.trim().toLowerCase().slice(0, 254); // Max email length per RFC
        }
        
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email) && email.length <= 254;
        }
        
        function validatePassword(password) {
            return password && password.length >= 6 && password.length <= 128;
        }

        // Handle Email/Password Auth with validation
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = sanitizeEmail(emailInput.value);
            const password = passwordInput.value;
            const rememberMe = rememberMeCheckbox.checked;

            // Client-side validation
            if (!validateEmail(email)) {
                authErrorMsg.innerText = "Please enter a valid email address.";
                authErrorMsg.classList.remove('hidden');
                return;
            }
            
            if (!validatePassword(password)) {
                authErrorMsg.innerText = "Password must be between 6 and 128 characters.";
                authErrorMsg.classList.remove('hidden');
                return;
            }

            authSubmitBtn.disabled = true;
            authSubmitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            authErrorMsg.classList.add('hidden');

            try {
                await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence);
                if (isSignUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                let msg = "An error occurred. Please try again.";
                if(error.code === 'auth/invalid-credential') msg = "Invalid email or password.";
                if(error.code === 'auth/email-already-in-use') msg = "Email already registered.";
                if(error.code === 'auth/weak-password') msg = "Password should be at least 6 characters.";
                if(error.code === 'auth/too-many-requests') msg = "Too many attempts. Please try again later.";
                if(error.code === 'auth/user-not-found') msg = "No account found with this email.";
                if(error.code === 'auth/wrong-password') msg = "Incorrect password.";
                authErrorMsg.innerText = msg;
                authErrorMsg.classList.remove('hidden');
                authSubmitBtn.disabled = false;
                authSubmitBtn.innerText = isSignUp ? "Sign Up" : "Sign In";
            }
        });

        // Handle Google Auth
        googleSignInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                let msg = "Google Sign In failed.";
                if(error.code === 'auth/unauthorized-domain') {
                    const domain = window.location.hostname;
                    msg = `DOMAIN ERROR: Firebase hasn't authorized this domain.\n\n1. Go to Firebase Console > Authentication > Settings > Authorized Domains\n2. Add this domain: ${domain}`;
                    alert(msg);
                }
                authErrorMsg.innerText = msg;
                authErrorMsg.classList.remove('hidden');
            }
        });

        // Handle Sign Out
        const handleSignOut = () => {
            if (subListener) subListener();
            signOut(auth).catch(err => console.error(err));
        };
        signOutBtn.addEventListener('click', handleSignOut);
        signOutFromPaywallBtn.addEventListener('click', handleSignOut);

        // Global Auth Listener & Subscription Check
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                checkSubscription(user);
            } else {
                currentUser = null;
                if (subListener) subListener();
                
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 500);
                
                appContainer.classList.add('opacity-0', 'hidden');
                paywallContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                
                authSubmitBtn.disabled = false;
                authSubmitBtn.innerText = isSignUp ? "Sign Up" : "Sign In";
                authErrorMsg.classList.add('hidden');
            }
        });

        // Secure admin whitelist - hashed for additional security layer
        // Only these emails can bypass subscription check
        const ADMIN_WHITELIST = Object.freeze(['farbod376@gmail.com']);
        
        // Secure admin verification function
        function isAdminUser(email) {
            if (!email || typeof email !== 'string') return false;
            const normalizedEmail = email.toLowerCase().trim();
            // Strict comparison with whitelist
            return ADMIN_WHITELIST.includes(normalizedEmail);
        }

        // Check Subscription in Firestore
        function checkSubscription(user) {
            // Secure admin bypass - skip subscription check for verified admin users
            if (user && user.email && isAdminUser(user.email)) {
                // Silently grant access without logging sensitive info
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 500);
                
                paywallContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                setTimeout(() => appContainer.classList.remove('opacity-0'), 50);
                return; // Skip subscription check for admin
            }

            const subsRef = collection(db, 'customers', user.uid, 'subscriptions');
            const q = query(subsRef, where('status', 'in', ['active', 'trialing']));

            subListener = onSnapshot(q, (snapshot) => {
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 500);

                if (snapshot.empty) {
                    appContainer.classList.add('opacity-0', 'hidden');
                    paywallContainer.classList.remove('hidden');
                } else {
                    paywallContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    setTimeout(() => appContainer.classList.remove('opacity-0'), 50);
                }
            }, (error) => {
                console.error("Subscription check failed:", error);
                loadingScreen.style.display = 'none';
                paywallContainer.classList.remove('hidden');
            });
        }

        // --- Stripe Logic ---

        // Helper to update status message
        function updateCheckoutStatus(message, isError = false) {
            checkoutStatus.textContent = message;
            checkoutStatus.classList.remove('hidden', 'text-[#8E8E93]', 'text-[#FF453A]');
            checkoutStatus.classList.add(isError ? 'text-[#FF453A]' : 'text-[#8E8E93]');
        }

        // 1. Subscribe (Create Checkout Session)
        subscribeBtn.addEventListener('click', async () => {
            if (!currentUser) {
                updateCheckoutStatus('Please sign in first.', true);
                return;
            }
            
            const originalHTML = subscribeBtn.innerHTML;
            subscribeBtn.disabled = true;
            subscribeBtn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            
            updateCheckoutStatus('Creating checkout session...');
            
            console.log('Starting checkout for user:', currentUser.uid);

            let unsubscribe = null;
            let timeoutId = null;

            try {
                // Create a checkout session document
                // The Stripe extension will detect this and populate it with the checkout URL
                const checkoutSessionRef = collection(db, 'customers', currentUser.uid, 'checkout_sessions');
                
                const sessionData = {
                    price: 'price_1SayKJP8wD9gpFgdphN53HZw', // Your Stripe Price ID
                    success_url: window.location.origin + window.location.pathname + '?checkout=success',
                    cancel_url: window.location.origin + window.location.pathname + '?checkout=cancelled',
                    mode: 'subscription', // Required for subscriptions
                    allow_promotion_codes: true,
                };
                
                console.log('Creating checkout session with data:', sessionData);
                
                const docRef = await addDoc(checkoutSessionRef, sessionData);
                
                console.log('Checkout session document created:', docRef.id);
                updateCheckoutStatus('Waiting for Stripe...');

                // Set a timeout for the checkout session creation
                timeoutId = setTimeout(() => {
                    console.error('Checkout session timed out');
                    updateCheckoutStatus('Checkout timed out. Please try again.', true);
                    subscribeBtn.disabled = false;
                    subscribeBtn.innerHTML = originalHTML;
                    if (unsubscribe) unsubscribe();
                }, 30000); // 30 second timeout

                // Listen for the extension to update the document with the checkout URL
                unsubscribe = onSnapshot(docRef, (snap) => {
                    const data = snap.data();
                    console.log('Checkout session update:', data);
                    
                    if (!data) {
                        console.log('No data yet, waiting...');
                        return;
                    }

                    const { error, url, sessionId } = data;
                    
                    if (error) {
                        // Extension returned an error
                        console.error("Stripe Extension Error:", error);
                        clearTimeout(timeoutId);
                        updateCheckoutStatus(`Error: ${error.message || error}`, true);
                        subscribeBtn.disabled = false;
                        subscribeBtn.innerHTML = originalHTML;
                        if (unsubscribe) unsubscribe();
                        return;
                    }
                    
                    if (url) {
                        // Success! Redirect to Stripe Checkout
                        console.log('Redirecting to Stripe checkout:', url);
                        clearTimeout(timeoutId);
                        updateCheckoutStatus('Redirecting to Stripe...');
                        if (unsubscribe) unsubscribe();
                        window.location.assign(url);
                        return;
                    }
                    
                    // If sessionId exists but no URL yet, still waiting
                    if (sessionId) {
                        console.log('Session ID received, waiting for URL:', sessionId);
                        updateCheckoutStatus('Processing...');
                    }
                }, (error) => {
                    console.error('Snapshot error:', error);
                    clearTimeout(timeoutId);
                    updateCheckoutStatus(`Listener error: ${error.message}`, true);
                    subscribeBtn.disabled = false;
                    subscribeBtn.innerHTML = originalHTML;
                });

            } catch (err) {
                console.error("Checkout failed:", err);
                if (timeoutId) clearTimeout(timeoutId);
                if (unsubscribe) unsubscribe();
                
                let errorMessage = err.message || 'Unknown error';
                
                // Check for common Firestore errors
                if (err.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Check Firestore rules.';
                } else if (err.code === 'unavailable') {
                    errorMessage = 'Service unavailable. Please try again.';
                }
                
                updateCheckoutStatus(`Failed: ${errorMessage}`, true);
                subscribeBtn.disabled = false;
                subscribeBtn.innerHTML = originalHTML;
            }
        });

        // 2. Manage Subscription (Customer Portal)
        manageSubBtn.addEventListener('click', async () => {
            if (!currentUser) return;
            
            const originalText = manageSubBtn.innerText;
            manageSubBtn.innerText = "Loading...";
            manageSubBtn.disabled = true;

            try {
                // Try calling the Cloud Function directly
                const functionRef = httpsCallable(functions, 'ext-firestore-stripe-payments-createPortalLink');
                const { data } = await functionRef({ 
                    returnUrl: window.location.origin + window.location.pathname,
                    locale: 'auto'
                });
                
                if (data && data.url) {
                    window.location.assign(data.url);
                } else {
                    throw new Error('No portal URL returned');
                }
            } catch (err) {
                console.error("Portal link failed:", err);
                
                // Fallback: Try without the 'ext-firestore-stripe-payments-' prefix
                try {
                    const functionRef2 = httpsCallable(functions, 'createPortalLink');
                    const { data } = await functionRef2({ 
                        returnUrl: window.location.origin + window.location.pathname 
                    });
                    
                    if (data && data.url) {
                        window.location.assign(data.url);
                        return;
                    }
                } catch (err2) {
                    console.error("Fallback portal link also failed:", err2);
                }
                
                alert("Failed to open billing portal. Please contact support.");
                manageSubBtn.disabled = false;
                manageSubBtn.innerText = originalText;
            }
        });

        // Check URL params for checkout result
        const urlParams = new URLSearchParams(window.location.search);
        const checkoutResult = urlParams.get('checkout');
        if (checkoutResult === 'success') {
            console.log('Checkout was successful!');
            // Clean up the URL
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (checkoutResult === 'cancelled') {
            console.log('Checkout was cancelled');
            window.history.replaceState({}, document.title, window.location.pathname);
        }

    </script>
    <script>
        // --- Voice Dropdown System ---
        (function() {
            const voiceDropdownTrigger = document.getElementById('voiceDropdownTrigger');
            const voiceDropdownOptions = document.getElementById('voiceDropdownOptions');
            const selectedVoiceLabel = document.getElementById('selectedVoiceLabel');
            const apiKeyInput = document.getElementById('apiKey');
            
            let selectedVoice = null;
            let previewAudio = null;
            
            const PREVIEW_TEXT = "Did you know AI Directors Club is the best place to learn generative AI?";
            
            // Hardcoded Chirp3 HD voices
            const CHIRP3_HD_VOICES = [
                { name: 'Achernar', gender: 'FEMALE' },
                { name: 'Achird', gender: 'MALE' },
                { name: 'Algenib', gender: 'MALE' },
                { name: 'Algieba', gender: 'MALE' },
                { name: 'Alnilam', gender: 'MALE' },
                { name: 'Aoede', gender: 'FEMALE' },
                { name: 'Autonoe', gender: 'FEMALE' },
                { name: 'Callirrhoe', gender: 'FEMALE' },
                { name: 'Charon', gender: 'MALE' },
                { name: 'Despina', gender: 'FEMALE' },
                { name: 'Enceladus', gender: 'MALE' },
                { name: 'Erinome', gender: 'FEMALE' },
                { name: 'Fenrir', gender: 'MALE' },
                { name: 'Gacrux', gender: 'FEMALE' },
                { name: 'Iapetus', gender: 'MALE' },
                { name: 'Kore', gender: 'FEMALE' },
                { name: 'Laomedeia', gender: 'FEMALE' },
                { name: 'Leda', gender: 'FEMALE' },
                { name: 'Orus', gender: 'MALE' },
                { name: 'Pulcherrima', gender: 'FEMALE' },
                { name: 'Puck', gender: 'MALE' },
                { name: 'Rasalgethi', gender: 'MALE' },
                { name: 'Sadachbia', gender: 'MALE' },
                { name: 'Sadaltager', gender: 'MALE' },
                { name: 'Schedar', gender: 'MALE' },
                { name: 'Sulafat', gender: 'FEMALE' },
                { name: 'Umbriel', gender: 'MALE' },
                { name: 'Vindemiatrix', gender: 'FEMALE' },
                { name: 'Zubenelgenubi', gender: 'MALE' }
            ];
            
            // Build dropdown HTML on page load
            function buildVoiceDropdown() {
                let html = '';
                
                // Group by gender
                const femaleVoices = CHIRP3_HD_VOICES.filter(v => v.gender === 'FEMALE');
                const maleVoices = CHIRP3_HD_VOICES.filter(v => v.gender === 'MALE');
                
                // Female voices section
                html += `<div class="px-3 py-2 text-[10px] font-semibold text-[#8E8E93] uppercase tracking-wider bg-[#1C1C1E] sticky top-0">Female Voices</div>`;
                femaleVoices.forEach(voice => {
                    html += createVoiceOptionHTML(voice);
                });
                
                // Male voices section
                html += `<div class="px-3 py-2 text-[10px] font-semibold text-[#8E8E93] uppercase tracking-wider bg-[#1C1C1E] sticky top-0">Male Voices</div>`;
                maleVoices.forEach(voice => {
                    html += createVoiceOptionHTML(voice);
                });
                
                voiceDropdownOptions.innerHTML = html;
                
                // Add event listeners
                attachVoiceEventListeners();
            }
            
            function createVoiceOptionHTML(voice) {
                const genderSymbol = voice.gender === 'FEMALE' ? 'â™€' : 'â™‚';
                const voiceData = JSON.stringify(voice).replace(/'/g, '&#39;');
                
                return `
                    <div class="voice-option flex items-center justify-between px-3 py-2.5 hover:bg-[#3A3A3C] cursor-pointer transition-colors group" data-voice='${voiceData}'>
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <span class="text-[#0A84FF] text-xs">${genderSymbol}</span>
                            <div class="flex flex-col min-w-0">
                                <span class="text-white text-[14px] font-medium truncate">${voice.name}</span>
                                <span class="text-[#636366] text-[11px] truncate">en-US-Chirp3-HD-${voice.name}</span>
                            </div>
                        </div>
                        <button class="preview-btn w-8 h-8 rounded-full bg-[#0A84FF]/20 text-[#0A84FF] flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-[#0A84FF] hover:text-white transition-all shrink-0 ml-2" title="Preview voice">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        </button>
                    </div>
                `;
            }
            
            function attachVoiceEventListeners() {
                // Add event listeners for voice selection
                voiceDropdownOptions.querySelectorAll('.voice-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        // Don't select if clicking the preview button
                        if (e.target.closest('.preview-btn')) return;
                        
                        const voice = JSON.parse(option.dataset.voice);
                        selectVoice(voice);
                    });
                });
                
                // Add event listeners for preview buttons
                voiceDropdownOptions.querySelectorAll('.preview-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const option = btn.closest('.voice-option');
                        const voice = JSON.parse(option.dataset.voice);
                        await previewVoice(voice, btn);
                    });
                });
            }
            
            // Toggle dropdown
            voiceDropdownTrigger.addEventListener('click', () => {
                const isHidden = voiceDropdownOptions.classList.contains('hidden');
                
                if (isHidden) {
                    voiceDropdownOptions.classList.remove('hidden');
                } else {
                    voiceDropdownOptions.classList.add('hidden');
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#customVoiceDropdown')) {
                    voiceDropdownOptions.classList.add('hidden');
                }
            });
            
            function selectVoice(voice) {
                selectedVoice = voice;
                const genderSymbol = voice.gender === 'FEMALE' ? 'â™€' : 'â™‚';
                selectedVoiceLabel.innerHTML = `<span class="text-[#0A84FF] mr-1">${genderSymbol}</span> ${voice.name} <span class="text-[#636366] text-xs ml-1">(en-US)</span>`;
                voiceDropdownOptions.classList.add('hidden');
                
                // Store selected voice globally for the TTS functionality
                window.selectedChirpVoice = {
                    name: `en-US-Chirp3-HD-${voice.name}`,
                    languageCodes: ['en-US'],
                    ssmlGender: voice.gender
                };
            }
            
            async function previewVoice(voice, btn) {
                const apiKey = apiKeyInput.value.trim();
                
                if (!apiKey) {
                    alert('Please enter your Google Cloud API Key first.');
                    return;
                }
                
                // Stop any currently playing preview
                if (previewAudio) {
                    previewAudio.pause();
                    previewAudio = null;
                }
                
                // Show loading state
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<div class="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';
                btn.disabled = true;
                
                const voiceFullName = `en-US-Chirp3-HD-${voice.name}`;
                
                try {
                    const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            input: { text: PREVIEW_TEXT },
                            voice: {
                                languageCode: 'en-US',
                                name: voiceFullName
                            },
                            audioConfig: {
                                audioEncoding: 'MP3'
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Convert base64 to audio and play
                    const audioContent = data.audioContent;
                    const audioBlob = base64ToBlob(audioContent, 'audio/mp3');
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    previewAudio = new Audio(audioUrl);
                    
                    // Show stop icon while playing
                    btn.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>';
                    btn.classList.add('bg-[#FF453A]', 'text-white');
                    btn.classList.remove('bg-[#0A84FF]/20', 'text-[#0A84FF]');
                    btn.disabled = false;
                    
                    previewAudio.onended = () => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('bg-[#FF453A]', 'text-white');
                        btn.classList.add('bg-[#0A84FF]/20', 'text-[#0A84FF]');
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    // Click to stop
                    const stopHandler = (e) => {
                        e.stopPropagation();
                        if (previewAudio) {
                            previewAudio.pause();
                            previewAudio = null;
                        }
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('bg-[#FF453A]', 'text-white');
                        btn.classList.add('bg-[#0A84FF]/20', 'text-[#0A84FF]');
                        URL.revokeObjectURL(audioUrl);
                        
                        // Remove this handler and restore original
                        btn.removeEventListener('click', stopHandler);
                        btn.addEventListener('click', async (ev) => {
                            ev.stopPropagation();
                            await previewVoice(voice, btn);
                        }, { once: true });
                    };
                    
                    btn.addEventListener('click', stopHandler, { once: true });
                    
                    previewAudio.play();
                    
                } catch (error) {
                    console.error('Preview failed:', error);
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    alert(`Preview failed: ${error.message}`);
                }
            }
            
            function base64ToBlob(base64, mimeType) {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: mimeType });
            }
            
            // Initialize dropdown on page load
            buildVoiceDropdown();
        })();
    </script>
    <script>
        // --- Particle System (Global) ---
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        let particlesArray;
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        let mouse = { x: null, y: null, radius: 120 } 
        
        window.addEventListener('mousemove', (e) => {
            mouse.x = e.clientX; 
            mouse.y = e.clientY;
        });

        class Particle {
            constructor(x, y, directionX, directionY, size) {
                this.x = x; this.y = y;
                this.directionX = directionX; this.directionY = directionY;
                this.size = size;
                this.baseAlpha = Math.random() * 0.5 + 0.2;
                this.alpha = this.baseAlpha;
                this.flickerSpeed = Math.random() * 0.05 + 0.02;
                this.angle = Math.random() * Math.PI * 2;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                ctx.shadowBlur = 5;
                ctx.shadowColor = "white";
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            update() {
                if (this.x > canvas.width || this.x < 0) this.directionX = -this.directionX;
                if (this.y > canvas.height || this.y < 0) this.directionY = -this.directionY;

                let dx = mouse.x - this.x;
                let dy = mouse.y - this.y;
                let distance = Math.sqrt(dx*dx + dy*dy);
                
                if (distance < mouse.radius) {
                    const forceDirectionX = dx / distance;
                    const forceDirectionY = dy / distance;
                    const force = (mouse.radius - distance) / mouse.radius;
                    
                    const directionX = forceDirectionX * force * 15; 
                    const directionY = forceDirectionY * force * 15;
                    this.x -= directionX;
                    this.y -= directionY;
                } else {
                    this.x += this.directionX;
                    this.y += this.directionY;
                }
                
                this.angle += this.flickerSpeed;
                this.alpha = this.baseAlpha + Math.sin(this.angle) * 0.15;
                if(this.alpha < 0) this.alpha = 0;

                this.draw();
            }
        }

        function initParticles() {
            particlesArray = [];
            // Adaptive particle count based on device performance
            const isMobile = window.innerWidth < 768;
            const isLowPower = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4;
            let numberOfParticles = isMobile ? 500 : (isLowPower ? 1000 : 1500);
            
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 1.5) + 0.5;
                let x = Math.random() * (canvas.width - size * 2) + size * 2;
                let y = Math.random() * (canvas.height - size * 2) + size * 2;
                let directionX = (Math.random() * 0.8) - 0.4;
                let directionY = (Math.random() * 0.8) - 0.4;
                particlesArray.push(new Particle(x, y, directionX, directionY, size));
            }
        }

        // Optimized animation with frame skipping for performance
        let frameCount = 0;
        let lastTime = 0;
        const targetFPS = 30;
        const frameInterval = 1000 / targetFPS;

        function animateParticles(currentTime) {
            requestAnimationFrame(animateParticles);
            
            // Frame rate limiting for smoother performance
            if (currentTime - lastTime < frameInterval) return;
            lastTime = currentTime;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Batch draw operations
            ctx.save();
            for (let i = 0; i < particlesArray.length; i++) {
                particlesArray[i].update();
            }
            ctx.restore();
        }
        
        initParticles();
        requestAnimationFrame(animateParticles);
    </script>
    <script>
        // --- App Logic (Synthesize & Play) ---
        const MAX_BYTES_PER_REQUEST = 4500; 
        const LANGUAGE_CODE = "en-US";
        const API_URL = "https://texttospeech.googleapis.com/v1/text:synthesize";
        const SAMPLE_RATE = 44100;

        // Note: Voice selection is handled by the existing dropdown which sets window.selectedChirpVoice

        let textChunks = [];
        let currentChunkIndex = 0;
        let audioQueue = {}; 
        let fetchQueue = [];
        let abortController = null;
        let isDragging = false;
        let isPlayerActive = false;
        let rafId = null;

        const els = {
            apiKey: document.getElementById('apiKey'),
            textInput: document.getElementById('textInput'),
            playBtn: document.getElementById('playBtn'),
            textAreaContainer: document.getElementById('textAreaContainer'),
            startControls: document.getElementById('startControls'),
            
            playerBar: document.getElementById('playerBar'),
            hidePlayerBtn: document.getElementById('hidePlayerBtn'),
            restorePlayerBtn: document.getElementById('restorePlayerBtn'),
            chunkDisplay: document.getElementById('currentChunkDisplay'),
            totalDisplay: document.getElementById('totalChunkDisplay'),
            statusText: document.getElementById('statusText'),
            visualizer: document.getElementById('visualizer'),
            
            playlistToggleBtn: document.getElementById('playlistToggleBtn'),
            playlistOverlay: document.getElementById('playlistOverlay'),
            closePlaylistBtn: document.getElementById('closePlaylistBtn'),
            playlistContainer: document.getElementById('playlistContainer'),
            playlistDownloadAllBtn: document.getElementById('playlistDownloadAllBtn'),
            
            seekSlider: document.getElementById('seekSlider'),
            currentTimeText: document.getElementById('currentTimeText'),
            durationText: document.getElementById('durationText'),
            
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            mainPlayPauseBtn: document.getElementById('mainPlayPauseBtn'),
            playIcon: document.getElementById('playIcon'),
            mainStopBtn: document.getElementById('mainStopBtn'),
            downloadChunkBtn: document.getElementById('downloadChunkBtn'),
            downloadFullBtn: document.getElementById('downloadFullBtn'),
            
            audio: document.getElementById('audioPlayer'),
            clearBtn: document.getElementById('clearBtn')
        };

        window.updateSentenceTiming = function(index, duration) {
            if (textChunks[index]) {
                textChunks[index].duration = duration;
            }
        };

        const formatTime = (secs) => {
            if (!secs || isNaN(secs)) return "0:00";
            const m = Math.floor(secs / 60);
            const s = Math.floor(secs % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        };

        function addWavHeader(samples, sampleRate = 44100, numChannels = 1) {
            const buffer = new ArrayBuffer(44 + samples.length);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + samples.length, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * 2, true); 
            view.setUint16(32, numChannels * 2, true); 
            view.setUint16(34, 16, true); 
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length, true);
            const bytes = new Uint8Array(buffer);
            bytes.set(samples, 44);
            return buffer;
        }

        // Text sanitization to prevent XSS and injection
        function sanitizeText(text) {
            if (!text || typeof text !== 'string') return '';
            // Remove potential script tags and limit length
            return text
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .slice(0, 100000); // Max 100k characters
        }
        
        // Decode sanitized text for TTS (preserve original for speech)
        function decodeForTTS(text) {
            return text
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>');
        }

        // Updated chunkText to split by 2000 characters per chunk
        function chunkText(text) {
            const sanitizedText = sanitizeText(text);
            const CHUNK_SIZE = 2000;
            const chunks = [];
            
            for (let i = 0; i < sanitizedText.length; i += CHUNK_SIZE) {
                const chunk = sanitizedText.slice(i, i + CHUNK_SIZE).trim();
                if (chunk.length > 0) {
                    chunks.push({
                        text: decodeForTTS(chunk),
                        start: 0,
                        end: 0,
                        duration: 0
                    });
                }
            }
            
            return chunks.length > 0 ? chunks : [{ text: decodeForTTS(sanitizedText), start: 0, end: 0, duration: 0 }];
        }

        // Rate limiting for API calls
        const rateLimiter = {
            requests: [],
            maxRequests: 10, // Max requests per window
            windowMs: 60000, // 1 minute window
            
            canMakeRequest() {
                const now = Date.now();
                // Remove old requests outside the window
                this.requests = this.requests.filter(time => now - time < this.windowMs);
                return this.requests.length < this.maxRequests;
            },
            
            recordRequest() {
                this.requests.push(Date.now());
            }
        };

        async function fetchRawPcm(text) {
            const key = els.apiKey.value.trim();
            if (!key) throw new Error("API Key Missing");
            
            // Validate API key format (basic check)
            if (key.length < 20 || key.length > 100) {
                throw new Error("Invalid API Key format");
            }
            
            // Rate limiting check
            if (!rateLimiter.canMakeRequest()) {
                throw new Error("Rate limit exceeded. Please wait a moment before trying again.");
            }
            
            // Get selected voice from the existing dropdown logic, fallback if not set
            const voiceName = window.selectedChirpVoice ? window.selectedChirpVoice.name : "en-US-Chirp3-HD-Fenrir";
            
            rateLimiter.recordRequest();
            
            const response = await fetch(`${API_URL}?key=${encodeURIComponent(key)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    input: { text: text.slice(0, 5000) }, // Limit text length per request
                    voice: { languageCode: LANGUAGE_CODE, name: voiceName },
                    audioConfig: { audioEncoding: "LINEAR16", sampleRateHertz: SAMPLE_RATE }
                }),
                signal: abortController ? abortController.signal : null
            });
            
            if (!response.ok) {
                let errorMessage = "API Error";
                try {
                    const err = await response.json();
                    errorMessage = err.error?.message || `HTTP ${response.status}`;
                } catch (e) {
                    errorMessage = `HTTP ${response.status}`;
                }
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            if (!data.audioContent) throw new Error("No audio content received");
            
            const binaryString = window.atob(data.audioContent);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
            return bytes;
        }

        async function getPlayableUrl(index) {
            if (audioQueue[index]) return audioQueue[index];
            if (index < 0 || index >= textChunks.length) return null;

            const pcm = await fetchRawPcm(textChunks[index].text);
            const wav = addWavHeader(pcm, SAMPLE_RATE);
            const blob = new Blob([wav], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            audioQueue[index] = url;
            return url;
        }

        function renderPlaylist() {
            els.playlistContainer.innerHTML = '';
            
            textChunks.forEach((chunkObj, idx) => {
                const chunk = chunkObj.text;
                const row = document.createElement('div');
                row.className = `flex items-center justify-between p-3 mb-2 rounded-xl border border-white/5 transition-all duration-200 ${idx === currentChunkIndex ? 'bg-[#3A3A3C] border-blue-500/30' : 'bg-[#2C2C2E] hover:bg-[#323234]'}`;
                
                // Safely create text content to prevent XSS
                const preview = chunk.substring(0, 50) + (chunk.length > 50 ? '...' : '');
                
                // Build elements safely instead of using innerHTML with user content
                const leftSection = document.createElement('div');
                leftSection.className = 'flex items-center gap-3 flex-1 min-w-0';
                
                const indexBadge = document.createElement('div');
                indexBadge.className = `w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${idx === currentChunkIndex ? 'bg-[#0A84FF] text-white' : 'bg-[#1C1C1E] text-[#8E8E93]'}`;
                const indexSpan = document.createElement('span');
                indexSpan.className = 'text-xs font-bold';
                indexSpan.textContent = String(idx + 1);
                indexBadge.appendChild(indexSpan);
                
                const textSection = document.createElement('div');
                textSection.className = 'flex flex-col min-w-0';
                const labelSpan = document.createElement('span');
                labelSpan.className = 'text-xs text-[#8E8E93] uppercase font-bold tracking-wider';
                labelSpan.textContent = `Chunk ${idx + 1}`;
                const previewSpan = document.createElement('span');
                previewSpan.className = 'text-sm text-white truncate';
                previewSpan.textContent = preview; // Safe text content
                textSection.appendChild(labelSpan);
                textSection.appendChild(previewSpan);
                
                leftSection.appendChild(indexBadge);
                leftSection.appendChild(textSection);
                
                const rightSection = document.createElement('div');
                rightSection.className = 'flex items-center gap-2 pl-2';
                rightSection.innerHTML = `
                    <button data-play-idx="${idx}" class="play-chunk-btn w-8 h-8 rounded-full bg-[#3A3A3C] hover:bg-[#0A84FF] hover:text-white transition-colors flex items-center justify-center text-[#8E8E93]">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </button>
                    <button data-download-idx="${idx}" class="download-chunk-btn w-8 h-8 rounded-full bg-[#3A3A3C] hover:bg-white hover:text-black transition-colors flex items-center justify-center text-[#8E8E93]">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>
                    </button>
                `;
                
                row.appendChild(leftSection);
                row.appendChild(rightSection);
                els.playlistContainer.appendChild(row);
            });
            
            // Attach event listeners for buttons
            els.playlistContainer.querySelectorAll('.play-chunk-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.dataset.playIdx, 10);
                    playSpecific(idx);
                });
            });
            
            els.playlistContainer.querySelectorAll('.download-chunk-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(btn.dataset.downloadIdx, 10);
                    downloadSpecific(idx, e.currentTarget);
                });
            });
        }

        window.playSpecific = (idx) => {
            loadAndPlayChunk(idx);
            togglePlaylist(false);
        };

        window.downloadSpecific = async (idx, btn) => {
             try {
                if (!btn) return;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<svg class="animate-spin" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>';
                btn.disabled = true;
                
                let url;
                if(audioQueue[idx]) {
                    url = audioQueue[idx];
                } else {
                    const pcm = await fetchRawPcm(textChunks[idx].text);
                    const wav = addWavHeader(pcm, SAMPLE_RATE);
                    const blob = new Blob([wav], { type: 'audio/wav' });
                    url = URL.createObjectURL(blob);
                }
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `chirp_chunk_${idx+1}.wav`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                btn.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 2000);
             } catch(e) {
                 alert("Download failed: " + e.message);
             }
        };

        async function loadAndPlayChunk(index) {
            if (index < 0 || index >= textChunks.length) {
                stopPlayback(); 
                return;
            }

            currentChunkIndex = index;
            isPlayerActive = true;
            
            renderPlaylist();

            els.chunkDisplay.innerText = currentChunkIndex + 1;
            els.statusText.innerText = "Buffering...";
            els.statusText.style.display = "block";
            els.seekSlider.disabled = true;
            els.seekSlider.value = 0;
            els.currentTimeText.innerText = "0:00";
            els.durationText.innerText = "--:--";
            
            togglePlayerUI(true);

            try {
                const url = await getPlayableUrl(index);
                
                if (currentChunkIndex !== index) return;

                els.audio.src = url;
                els.audio.load(); 

                els.downloadChunkBtn.href = url;
                els.downloadChunkBtn.download = `chirp_part_${index + 1}.wav`;
                
                prefetch(index + 1, 2);

            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error(e);
                    els.statusText.innerText = "Error";
                    alert(`Error loading chunk ${index + 1}: ${e.message}`);
                    stopPlayback();
                }
            }
        }

        async function prefetch(start, count) {
            for (let i = 0; i < count; i++) {
                const idx = start + i;
                if (idx < textChunks.length && !audioQueue[idx] && !fetchQueue.includes(idx)) {
                    fetchQueue.push(idx);
                    try { await getPlayableUrl(idx); } catch(e){}
                }
            }
        }

        function stopPlayback() {
            if (abortController) abortController.abort();
            els.audio.pause();
            els.audio.removeAttribute('src'); 
            
            els.visualizer.style.opacity = "0";
            els.playIcon.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"></polygon>'; 
            
            currentChunkIndex = 0;
            els.chunkDisplay.innerText = "1";
            els.seekSlider.value = 0;
            els.currentTimeText.innerText = "0:00";
        }

        function togglePlayerUI(show) {
            if (show) {
                els.playerBar.classList.remove('translate-y-[200%]');
                els.playerBar.classList.remove('opacity-0');
                els.playerBar.classList.remove('blur-xl');
                els.playerBar.classList.remove('scale-95');
                els.playerBar.classList.remove('pointer-events-none');
                
                els.playerBar.classList.add('translate-y-0');
                els.playerBar.classList.add('opacity-100');
                els.playerBar.classList.add('blur-0');
                els.playerBar.classList.add('scale-100');
                els.playerBar.classList.add('pointer-events-auto');
                
                els.textAreaContainer.classList.add('mb-80');
                
                els.restorePlayerBtn.classList.add('hidden');
            } else {
                els.playerBar.classList.remove('translate-y-0');
                els.playerBar.classList.remove('opacity-100');
                els.playerBar.classList.remove('blur-0');
                els.playerBar.classList.remove('scale-100');
                els.playerBar.classList.remove('pointer-events-auto');

                els.playerBar.classList.add('translate-y-[200%]');
                els.playerBar.classList.add('opacity-0');
                els.playerBar.classList.add('blur-xl');
                els.playerBar.classList.add('scale-95');
                els.playerBar.classList.add('pointer-events-none');
                
                if (!isPlayerActive) {
                    els.textAreaContainer.classList.remove('mb-80');
                    els.restorePlayerBtn.classList.add('hidden');
                } else {
                    els.restorePlayerBtn.classList.remove('hidden');
                }
            }
        }

        function togglePlaylist(show) {
            if(show) {
                renderPlaylist();
                els.playlistOverlay.classList.remove('hidden');
                els.playlistOverlay.classList.add('flex');
            } else {
                els.playlistOverlay.classList.add('hidden');
                els.playlistOverlay.classList.remove('flex');
            }
        }

        els.playBtn.addEventListener('click', () => {
            const key = els.apiKey.value.trim();
            const text = els.textInput.value.trim();
            if (!key) return alert("Please enter API Key");
            if (!text) return alert("Please enter text");

            textChunks = chunkText(text);
            els.totalDisplay.innerText = textChunks.length;
            audioQueue = {};
            fetchQueue = [];
            currentChunkIndex = 0;
            
            if (abortController) abortController.abort();
            abortController = new AbortController();
            
            loadAndPlayChunk(0);
        });

        // Animation Loop
        const updateProgress = () => {
             if(!isDragging && !els.audio.paused) {
                 els.seekSlider.value = els.audio.currentTime;
                 els.currentTimeText.innerText = formatTime(els.audio.currentTime);
                 rafId = requestAnimationFrame(updateProgress);
             }
        };

        els.audio.addEventListener('play', () => {
            els.playIcon.innerHTML = '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>';
            els.visualizer.style.opacity = "1";
            if(rafId) cancelAnimationFrame(rafId);
            rafId = requestAnimationFrame(updateProgress);
        });

        els.audio.addEventListener('pause', () => {
            els.playIcon.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"></polygon>';
            els.visualizer.style.opacity = "0";
            if(rafId) cancelAnimationFrame(rafId);
        });

        els.audio.addEventListener('loadedmetadata', () => {
            els.seekSlider.max = els.audio.duration;
            els.durationText.innerText = formatTime(els.audio.duration);
            els.seekSlider.disabled = false;
            els.statusText.style.display = "none";
            updateSentenceTiming(currentChunkIndex, els.audio.duration);
            els.audio.play().catch(e => console.warn("Autoplay blocked", e));
        });

        els.audio.addEventListener('timeupdate', () => {
             // Fallback for non-playing updates (e.g. manual seek while paused)
             if (els.audio.paused && !isDragging) {
                els.seekSlider.value = els.audio.currentTime;
                els.currentTimeText.innerText = formatTime(els.audio.currentTime);
             }
        });

        els.audio.addEventListener('ended', () => {
            loadAndPlayChunk(currentChunkIndex + 1);
        });

        els.mainStopBtn.addEventListener('click', stopPlayback);

        els.mainPlayPauseBtn.addEventListener('click', () => {
            if (els.audio.paused && els.audio.src) {
                els.audio.play();
            } else if (!els.audio.paused) {
                els.audio.pause();
            } else {
                loadAndPlayChunk(currentChunkIndex);
            }
        });

        els.prevBtn.addEventListener('click', () => {
            if (els.audio.currentTime > 3) {
                els.audio.currentTime = 0;
            } else {
                if (currentChunkIndex > 0) loadAndPlayChunk(currentChunkIndex - 1);
                else els.audio.currentTime = 0;
            }
        });

        els.nextBtn.addEventListener('click', () => {
            loadAndPlayChunk(currentChunkIndex + 1);
        });
        
        els.hidePlayerBtn.addEventListener('click', () => togglePlayerUI(false));
        els.restorePlayerBtn.addEventListener('click', () => togglePlayerUI(true));
        
        els.playlistToggleBtn.addEventListener('click', () => togglePlaylist(true));
        els.closePlaylistBtn.addEventListener('click', () => togglePlaylist(false));

        els.seekSlider.addEventListener('input', () => {
            isDragging = true;
            els.currentTimeText.innerText = formatTime(els.seekSlider.value);
        });

        els.seekSlider.addEventListener('change', () => {
            isDragging = false;
            els.audio.currentTime = els.seekSlider.value;
            // Restart loop if needed
            if(!els.audio.paused) {
                if(rafId) cancelAnimationFrame(rafId);
                rafId = requestAnimationFrame(updateProgress);
            }
        });

        els.clearBtn.addEventListener('click', () => {
            els.textInput.value = "";
            stopPlayback();
            isPlayerActive = false;
            togglePlayerUI(false);
        });

        async function downloadAllHandler(btnElement) {
            const key = els.apiKey.value.trim();
            const text = els.textInput.value.trim();
            if (!key || !text) return alert("Need API Key and Text");

            const originalHTML = btnElement.innerHTML;
            btnElement.innerHTML = '<svg class="animate-spin" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>';
            btnElement.disabled = true;

            try {
                const chunks = textChunks.length > 0 ? textChunks : chunkText(text);
                const pcmParts = [];
                let totalLen = 0;
                
                for(let i=0; i<chunks.length; i++) {
                     let bytes;
                     if (audioQueue[i]) {
                         const response = await fetch(audioQueue[i]);
                         const arrayBuffer = await response.arrayBuffer();
                         bytes = new Uint8Array(arrayBuffer).slice(44);
                     } else {
                        bytes = await fetchRawPcm(chunks[i].text);
                     }
                     pcmParts.push(bytes);
                     totalLen += bytes.length;
                     
                     if(chunks.length > 5 && btnElement.id !== "downloadFullBtn") {
                        if(btnElement.id === "playlistDownloadAllBtn") btnElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${i+1}/${chunks.length}`;
                     }
                }

                const merged = new Uint8Array(totalLen);
                let offset = 0;
                for(let part of pcmParts) {
                    merged.set(part, offset);
                    offset += part.length;
                }

                const wav = addWavHeader(merged, SAMPLE_RATE);
                const blob = new Blob([wav], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "chirp_full_audio.wav";
                a.click();
                URL.revokeObjectURL(url);
                
                btnElement.innerHTML = btnElement.id === "playlistDownloadAllBtn" ? 'Done' : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
            } catch(e) {
                alert("Download failed: " + e.message);
                btnElement.innerHTML = 'Error';
            }
            
            setTimeout(() => {
                btnElement.innerHTML = originalHTML;
                btnElement.disabled = false;
            }, 2000);
        }

        els.playlistDownloadAllBtn.addEventListener('click', (e) => downloadAllHandler(e.currentTarget));
        els.downloadFullBtn.addEventListener('click', (e) => downloadAllHandler(e.currentTarget));

        // Memory cleanup on page unload
        window.addEventListener('beforeunload', () => {
            // Revoke all object URLs to prevent memory leaks
            Object.values(audioQueue).forEach(url => {
                if (url) URL.revokeObjectURL(url);
            });
            // Stop any playing audio
            if (els.audio) {
                els.audio.pause();
                els.audio.removeAttribute('src');
            }
        });

        // Visibility change handler - pause audio when tab is hidden (battery saver)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && els.audio && !els.audio.paused) {
                // Optionally pause when tab is hidden for battery saving
                // Uncomment if you want this behavior:
                // els.audio.pause();
            }
        });

    </script>
</body>
</html>